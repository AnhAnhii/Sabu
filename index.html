<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BU ‚ô• SARAM</title>
  <style>
    :root{
      --bg:#000; --ui:#111; --ui2:#1b1b1b; --bd:#2a2a2a; --txt:#dcdcdc;
      --accent:#ff4780; --accent2:#33aaff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    .wrap{position:relative;height:100%;width:100%}
    /* 2 l·ªõp canvas x·∫øp ch·ªìng */
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    #pulse{z-index:1}  /* tim ƒë·∫≠p */
    #burst{z-index:2;mix-blend-mode:screen} /* h·∫°t xanh */
    /* b·∫£ng ƒëi·ªÅu khi·ªÉn */
    .panel{
      position:fixed;top:12px;left:12px;z-index:9;
      background:rgba(20,20,20,.7);border:1px solid var(--bd);
      border-radius:12px;backdrop-filter:saturate(120%) blur(8px);
      padding:10px 12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center
    }
    .group{display:flex;gap:8px;align-items:center}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid var(--bd);background:var(--ui2);font-size:12px;color:#bbb}
    input[type="range"]{width:140px}
    a.gh{position:fixed;right:12px;top:12px;z-index:9;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;background:var(--ui);text-decoration:none;color:#aaa;font-size:12px}
    .credit{position:fixed;right:12px;bottom:10px;opacity:.5;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- l·ªõp n·ªÅn tim ƒë·∫≠p -->
    <canvas id="pulse"></canvas>
    <!-- l·ªõp h·∫°t xanh -->
    <canvas id="burst"></canvas>
  </div>

  <div class="panel">
    <span class="tag">Layers</span>
    <label class="group"><input type="checkbox" id="togglePulse" checked /> ‚ù§Ô∏è Pulse</label>
    <label class="group"><input type="checkbox" id="toggleBurst" checked /> üíô Burst</label>
    <span class="tag">Controls</span>
    <label class="group">Speed <input id="speed" type="range" min="0.5" max="2.0" step="0.05" value="1.0" /></label>
    <label class="group">Size <input id="size" type="range" min="1" max="4" step="1" value="2" /></label>
  </div>

  <a class="gh" href="#" onclick="location.reload()">Reload</a>
  <div class="credit">Saram ‚Ä¢ JS/Canvas</div>

  <script>
  /* =========================
     COMMON: resize helpers
  ========================= */
  function makeScaler(canvas, baseW, baseH){
    const ctx = canvas.getContext('2d');
    function resize(){
      const ratio = Math.min(window.innerWidth/baseW, window.innerHeight/baseH);
      const cssW = Math.round(baseW * ratio);
      const cssH = Math.round(baseH * ratio);
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.style.width = cssW + 'px';
      canvas.style.height = cssH + 'px';
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(canvas.width/baseW, 0, 0, canvas.height/baseH, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();
    return ctx;
  }

  /* =========================
     LAYER 1: HEART PULSE
     (port t·ª´ Python/Tkinter)
  ========================= */
  (function(){
    const canvas = document.getElementById('pulse');
    const ctx = makeScaler(canvas, 640, 480);

    const CANVAS_WIDTH = 640, CANVAS_HEIGHT = 480;
    const CENTER_X = CANVAS_WIDTH/2, CENTER_Y = CANVAS_HEIGHT/2;
    const IMAGE_ENLARGE = 11;
    let HEART_COLOR = "#ff6aa2";

    const DIST_EXPONENT = 0.520;
    const FRAME_COUNT = 20;

    const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];

    function heartFunction(t, ratio=IMAGE_ENLARGE){
      let x = 16 * Math.pow(Math.sin(t), 3);
      let y = -(13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
      x*=ratio; y*=ratio; x+=CENTER_X; y+=CENTER_Y;
      return [x,y];
    }
    function scatterInside(x,y,beta=.15){
      const ratioX=beta*Math.log(Math.random()), ratioY=beta*Math.log(Math.random());
      const dx=ratioX*(x-CENTER_X), dy=ratioY*(y-CENTER_Y);
      return [x-dx, y-dy];
    }
    function shrinkPoint(x,y,ratio){
      const dx=x-CENTER_X, dy=y-CENTER_Y, force=-1/Math.pow(dx*dx+dy*dy,0.6);
      return [x - ratio*force*dx, y - ratio*force*dy];
    }
    function curve(p){ return 2*(2+Math.sin(4*p))/(2*Math.PI); }
    function calcPosition(x,y,ratio){
      const dx=x-CENTER_X, dy=y-CENTER_Y;
      const force=1/Math.pow(dx*dx+dy*dy, DIST_EXPONENT);
      return [ x - (ratio*force*dx + rand(-1,1)), y - (ratio*force*dy + rand(-1,1)) ];
    }

    // Build base points
    const pointsBase = new Set(), edgeDiff = new Set(), centerDiff = new Set();
    const key=(x,y)=>(x|0)+'|'+(y|0);

    (function build(number=2000){
      for(let i=0;i<number;i++){
        const t=Math.random()*2*Math.PI; let [x,y]=heartFunction(t); pointsBase.add(key(x,y));
      }
      for(const k of pointsBase){
        const [x0,y0]=k.split('|').map(Number);
        for(let i=0;i<3;i++){ let [x,y]=scatterInside(x0,y0,0.05); edgeDiff.add(key(x,y)); }
      }
      const listBase = Array.from(pointsBase, k=>k.split('|').map(Number));
      for(let i=0;i<4000;i++){
        let [x,y]=choice(listBase); [x,y]=scatterInside(x,y,0.17); centerDiff.add(key(x,y));
      }
    })();

    function makeFrame(idx){
      const p=(idx/10)*Math.PI, ratio=10*curve(p);
      const haloRadius = Math.floor(4 + 6*(1+curve(p)));
      const haloNumber = Math.floor(3000 + 4000*Math.abs(curve(p)));
      const all=[];

      const haloSet=new Set();
      for(let i=0;i<haloNumber;i++){
        const t=Math.random()*2*Math.PI; let [x,y]=heartFunction(t,11.6);
        [x,y]=shrinkPoint(x,y,haloRadius); x|=0; y|=0; const kk=key(x,y);
        if(!haloSet.has(kk)){
          haloSet.add(kk); x+=rand(-14,14); y+=rand(-14,14);
          all.push([x,y, choice([1,2,2]) ]);
        }
      }
      for(const k of pointsBase){
        let [x,y]=k.split('|').map(Number); [x,y]=calcPosition(x,y,ratio);
        all.push([x,y, rand(1,3)]);
      }
      for(const k of edgeDiff){
        let [x,y]=k.split('|').map(Number); [x,y]=calcPosition(x,y,ratio);
        all.push([x,y, rand(1,2)]);
      }
      for(const k of centerDiff){
        let [x,y]=k.split('|').map(Number); [x,y]=calcPosition(x,y,ratio);
        all.push([x,y, rand(1,2)]);
      }
      return all;
    }
    const frames = Array.from({length:FRAME_COUNT},(_,i)=>makeFrame(i));

    // public API for main loop
    window.__pulse = {
      draw(ctx, frameIdx, sizeBoost=0, color=HEART_COLOR){
        const pts = frames[frameIdx % FRAME_COUNT];
        ctx.fillStyle = color;
        for(let i=0;i<pts.length;i++){
          const [x,y,s] = pts[i];
          const m = s + sizeBoost;
          ctx.fillRect(x,y,m,m);
        }
      },
      clear(){ ctx.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT); },
      ctx, w:CANVAS_WIDTH, h:CANVAS_HEIGHT
    };
  })();

  /* =========================
     LAYER 2: BLUE PARTICLE BURST
     (ËìùËâ≤Áà±ÂøÉÁ≤íÂ≠ê + accumulator)
  ========================= */
  (function(){
    const canvas = document.getElementById('burst');
    const ctx = makeScaler(canvas, 640, 480);
    const W=640, H=480, cx=W/2, cy=H/2;
    const settings = {
      particles:{ length:800, duration:2.2, velocity:120, effect:-0.75, size:28 },
      color:"#33aaff"
    };

    function Point(x,y){this.x=x||0;this.y=y||0}
    Point.prototype.clone=function(){return new Point(this.x,this.y)}
    Point.prototype.length=function(len){ if(len===undefined) return Math.hypot(this.x,this.y); this.normalize(); this.x*=len; this.y*=len; return this }
    Point.prototype.normalize=function(){ const l=this.length(); if(l){this.x/=l;this.y/=l} return this }

    function Particle(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0}
    Particle.prototype.initialize=function(x,y,dx,dy){
      this.position.x=x;this.position.y=y;this.velocity.x=dx;this.velocity.y=dy;
      this.acceleration.x=dx*settings.particles.effect; this.acceleration.y=dy*settings.particles.effect; this.age=0;
    }
    Particle.prototype.update=function(dt){
      this.velocity.x+=this.acceleration.x*dt; this.velocity.y+=this.acceleration.y*dt;
      this.position.x+=this.velocity.x*dt; this.position.y+=this.velocity.y*dt; this.age+=dt;
    }
    Particle.prototype.draw=function(c, img){
      const ease=t=>{t--;return t*t*t+1}; const life=this.age/settings.particles.duration;
      const size=img.width*ease(life); c.globalAlpha=1-life;
      c.drawImage(img,this.position.x-size/2,this.position.y-size/2,size,size);
    }

    function ParticlePool(n){this.p=new Array(n).fill(0).map(()=>new Particle());this.a=0;this.f=0;this.d=settings.particles.duration}
    ParticlePool.prototype.add=function(x,y,dx,dy){this.p[this.f].initialize(x,y,dx,dy);this.f=(this.f+1)%this.p.length;if(this.f===this.a)this.a=(this.a+1)%this.p.length}
    ParticlePool.prototype.update=function(dt){
      if(this.a!==this.f){let i=this.a;while(i!==this.f){const P=this.p[i];P.update(dt);if(P.age>=this.d){this.a=(this.a+1)%this.p.length;i=this.a}else{i=(i+1)%this.p.length}}}
    }
    ParticlePool.prototype.draw=function(c,img){ if(this.a===this.f)return; let i=this.a; while(i!==this.f){this.p[i].draw(c,img); i=(i+1)%this.p.length} }

    function pointOnHeart(t){
      return new Point(16*Math.pow(Math.sin(t),3), 13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
    }
    function createHeartImage(size){
      const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); g.fillStyle=settings.color;
      g.translate(size/2,size/2); const s=size/32; g.scale(s,s); g.beginPath();
      for(let t=-Math.PI;t<Math.PI;t+=0.01){const p=pointOnHeart(t); g.lineTo(p.x,-p.y)}
      g.closePath(); g.fill(); return c;
    }

    const image = createHeartImage(settings.particles.size);
    const scale = Math.min(W,H)/40;
    const pool = new ParticlePool(settings.particles.length);
    const emitRate = settings.particles.length/settings.particles.duration;
    let acc = 0;

    // burst kh·ªüi ƒë·ªông
    for(let i=0;i<settings.particles.length;i++){
      const t=Math.random()*2*Math.PI, pos=pointOnHeart(t);
      const x=cx+pos.x*scale, y=cy-pos.y*scale;
      const dir=pos.clone().normalize().length(settings.particles.velocity);
      pool.add(x,y,dir.x,-dir.y);
    }

    window.__burst = {
      step(dt){
        acc += emitRate*dt;
        while(acc>=1){
          const t=Math.random()*2*Math.PI, pos=pointOnHeart(t);
          const x=cx+pos.x*scale, y=cy-pos.y*scale;
          const dir=pos.clone().normalize().length(settings.particles.velocity);
          pool.add(x,y,dir.x,-dir.y); acc -= 1;
        }
        pool.update(dt);
      },
      draw(c){ c.clearRect(0,0,W,H); pool.draw(c,image); c.globalAlpha=1; },
      ctx
    };
  })();

  /* =========================
     MASTER LOOP + UI
  ========================= */
  const speedCtrl = document.getElementById('speed');
  const sizeCtrl  = document.getElementById('size');
  const chkPulse  = document.getElementById('togglePulse');
  const chkBurst  = document.getElementById('toggleBurst');

  let frame = 0, last = performance.now();

  function tick(t){
    requestAnimationFrame(tick);
    const baseInterval = 160; // ~6 FPS nh∆∞ b·∫£n Tkinter
    const speed = parseFloat(speedCtrl.value);

    // b∆∞·ªõc th·ªùi gian cho burst (60fps logic)
    const dt = Math.min(0.032, (t - last) / 1000);

    if (chkBurst.checked) {
      __burst.step(dt);
      __burst.draw(__burst.ctx);
    } else {
      // clear n·∫øu t·∫Øt
      __burst.ctx.clearRect(0,0,__burst.ctx.canvas.width, __burst.ctx.canvas.height);
    }

    if (t - last >= baseInterval / speed) {
      last = t;
      if (chkPulse.checked) {
        __pulse.clear();
        const boost = parseInt(sizeCtrl.value, 10) - 2;
        __pulse.draw(__pulse.ctx, frame, boost, "#ff6aa2");
        frame++;
      } else {
        __pulse.clear();
      }
    }
  }
  requestAnimationFrame(tick);
  </script>
</body>
</html>
