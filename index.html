<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BU ♥ SARAM</title>
  <style>
    html,body{
      margin:0;height:100%;background:#000;overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif
    }
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    p{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      color:#ff9ecb;margin:0;animation:k 1.5s ease-in-out infinite;
      pointer-events:none;user-select:none
    }
    @keyframes k{0%{font-size:18px;opacity:.9}100%{font-size:24px;opacity:0}}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <p>❤</p>

  <script>
  const settings = {
    particles:{ length:800, duration:2.2, velocity:120, effect:-0.75, size:32 },
    colors:{ particle:"#ffee33" }
  };

  // RAF polyfill
  (()=>{let t=0,v=['ms','moz','webkit','o'];for(let i=0;i<v.length&&!window.requestAnimationFrame;i++){
    window.requestAnimationFrame=window[v[i]+'RequestAnimationFrame'];
    window.cancelAnimationFrame=window[v[i]+'CancelAnimationFrame']||window[v[i]+'CancelRequestAnimationFrame'];
  }
  if(!window.requestAnimationFrame){window.requestAnimationFrame=cb=>{const n=performance.now(),d=Math.max(0,16-(n-t));const id=setTimeout(()=>cb(n+d),d);t=n+d;return id}}
  if(!window.cancelAnimationFrame){window.cancelAnimationFrame=id=>clearTimeout(id)}})();

  function Point(x,y){this.x=x||0;this.y=y||0}
  Point.prototype.clone=function(){return new Point(this.x,this.y)}
  Point.prototype.length=function(len){if(len===undefined)return Math.hypot(this.x,this.y);this.normalize();this.x*=len;this.y*=len;return this}
  Point.prototype.normalize=function(){const l=this.length();if(l!==0){this.x/=l;this.y/=l}return this}

  function Particle(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0}
  Particle.prototype.initialize=function(x,y,dx,dy){
    this.position.x=x;this.position.y=y;
    this.velocity.x=dx;this.velocity.y=dy;
    this.acceleration.x=dx*settings.particles.effect;
    this.acceleration.y=dy*settings.particles.effect;
    this.age=0
  }
  Particle.prototype.update=function(dt){
    this.velocity.x+=this.acceleration.x*dt; this.velocity.y+=this.acceleration.y*dt;
    this.position.x+=this.velocity.x*dt;     this.position.y+=this.velocity.y*dt;
    this.age+=dt
  }
  Particle.prototype.draw=function(ctx,img){
    function ease(t){return (--t)*t*t+1}
    const life=this.age/settings.particles.duration;
    const size=img.width*ease(life);
    ctx.globalAlpha=1-life;
    ctx.drawImage(img,this.position.x-size/2,this.position.y-size/2,size,size)
  }

  function ParticlePool(n){
    this.particles=new Array(n);for(let i=0;i<n;i++)this.particles[i]=new Particle();
    this.firstActive=0;this.firstFree=0;this.duration=settings.particles.duration
  }
  ParticlePool.prototype.add=function(x,y,dx,dy){
    this.particles[this.firstFree].initialize(x,y,dx,dy);
    this.firstFree=(this.firstFree+1)%this.particles.length;
    if(this.firstFree===this.firstActive)this.firstActive=(this.firstActive+1)%this.particles.length
  }
  ParticlePool.prototype.update=function(dt){
    if(this.firstActive!==this.firstFree){
      let i=this.firstActive;
      while(i!==this.firstFree){
        const p=this.particles[i]; p.update(dt);
        if(p.age>=this.duration){
          this.firstActive=(this.firstActive+1)%this.particles.length;
          i=this.firstActive
        }else{ i=(i+1)%this.particles.length }
      }
    }
  }
  ParticlePool.prototype.draw=function(ctx,img){
    if(this.firstActive===this.firstFree)return;
    let i=this.firstActive;
    while(i!==this.firstFree){ this.particles[i].draw(ctx,img); i=(i+1)%this.particles.length }
  }

  function pointOnHeart(t){
    return new Point(
      16*Math.pow(Math.sin(t),3),
      13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)
    )
  }

  function createHeartImage(size){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d'); ctx.fillStyle=settings.colors.particle;
    ctx.translate(size/2,size/2); const s=size/32; ctx.scale(s,s);
    ctx.beginPath(); for(let t=-Math.PI;t<Math.PI;t+=0.01){const p=pointOnHeart(t); ctx.lineTo(p.x,-p.y) }
    ctx.closePath(); ctx.fill(); return c
  }

  const canvas=document.getElementById('c'), ctx=canvas.getContext('2d');
  let W,H,cx,cy,scale,image,pool,emitRate,maxParticles,emissionAcc=0;

  function resize(){
    W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight;
    cx=W/2; cy=H/2; scale=Math.min(W,H)/40;
    image=createHeartImage(settings.particles.size);
    maxParticles=settings.particles.length;
    pool=new ParticlePool(maxParticles);
    emitRate=maxParticles/settings.particles.duration;
    emissionAcc=0;

    // ---- burst khởi động để thấy ngay:
    for(let i=0;i<maxParticles;i++){
      const t=Math.random()*2*Math.PI, pos=pointOnHeart(t);
      const x=cx+pos.x*scale, y=cy-pos.y*scale;
      const dir=pos.clone().normalize().length(settings.particles.velocity);
      pool.add(x,y,dir.x,-dir.y)
    }
  }
  window.addEventListener('resize',resize); resize();

  let prev=performance.now();
  (function loop(now){
    requestAnimationFrame(loop);
    const dt=Math.min(0.032,(now-prev)/1000); prev=now;

    // --- phát hạt dùng accumulator (sửa lỗi <1 hạt/frame)
    emissionAcc+=emitRate*dt;
    while(emissionAcc>=1){
      const t=Math.random()*2*Math.PI, pos=pointOnHeart(t);
      const x=cx+pos.x*scale, y=cy-pos.y*scale;
      const dir=pos.clone().normalize().length(settings.particles.velocity);
      pool.add(x,y,dir.x,-dir.y);
      emissionAcc-=1;
    }

    pool.update(dt);
    ctx.clearRect(0,0,W,H);
    pool.draw(ctx,image);
    ctx.globalAlpha=1;
  })(prev);
  </script>
</body>
</html>
